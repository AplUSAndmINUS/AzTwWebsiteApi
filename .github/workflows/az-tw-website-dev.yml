name: Azure Function App Dev Deployment

on:
  push:
    branches:
      - development
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME_DEV: 'az-tw-website-dev-func'
  OUTPUT_PATH: './output'
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: development

    steps:
    - name: 'Checkout Code'
      uses: actions/checkout@v4

    - name: 'Setup .NET'
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 'Build and Package Function'
      run: |
        mkdir -p ${{ env.OUTPUT_PATH }}
        dotnet publish ./src/Functions/AzTwWebsiteApi.Functions.csproj \
          --configuration Release \
          --output ${{ env.OUTPUT_PATH }} \
          -p:GenerateFunctionMetadata=true
        
        cd ${{ env.OUTPUT_PATH }}
        zip -r ../function-app.zip ./*
        cd ..

    - name: 'Login to Azure'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 'Deploy Function App Zip Directly'
      run: |
        az functionapp deployment source config-zip \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME_DEV }} \
          --resource-group az-tw-website-functions \
          --src function-app.zip

    - name: 'Restart Function App'
      run: |
        az functionapp restart --name ${{ env.AZURE_FUNCTIONAPP_NAME_DEV }} \
          --resource-group az-tw-website-functions
