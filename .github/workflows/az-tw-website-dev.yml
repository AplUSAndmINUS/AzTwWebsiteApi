name: Azure Function App Dev Deployment

on:
  push:
    branches:
      - development
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './src/Functions'
  OUTPUT_PATH: './output'
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: development

    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: Setup DotNet ${{ env.DOTNET_VERSION }} Environment
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 'Login via Azure CLI'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 'Build and Publish Functions'
      shell: bash
      env:
        FUNCTIONS_WORKER_RUNTIME: "dotnet-isolated"
        DOTNET_SYSTEM_GLOBALIZATION_INVARIANT: 1
      run: |
        # Clean output directory
        rm -rf ./output
        mkdir -p ./output

        # Build solution
        echo "üî® Building solution..."
        dotnet restore AzTwWebsiteApi.sln
        dotnet clean AzTwWebsiteApi.sln --configuration Release
        dotnet build AzTwWebsiteApi.sln --configuration Release
        
        # Publish functions
        echo "üì¶ Publishing functions..."
        dotnet publish src/Functions/Blog/BlogFunctions.csproj \
          --configuration Release \
          --output ./output \
          --runtime linux-x64 \
          --self-contained false \
          -p:PublishReadyToRun=false \
          -p:GenerateRuntimeConfigurationFiles=true \
          -p:UseAppHost=false
        
        # Verify function.json files
        echo "üîç Checking for function.json files..."
        find ./output -name "function.json" -type f -exec echo "Found: {}" \; -exec cat {} \;
        
        # Ensure proper function app structure
        echo "ÔøΩ Setting up function app structure..."
        
        # Copy host.json
        cp src/Functions/Blog/host.json ./output/
        
        # Create minimal local.settings.json
        echo '{
          "IsEncrypted": false,
          "Values": {
            "FUNCTIONS_WORKER_RUNTIME": "dotnet-isolated",
            "AzureWebJobsStorage": "",
            "FUNCTIONS_EXTENSION_VERSION": "~4",
            "WEBSITE_RUN_FROM_PACKAGE": "1"
          }
        }' > ./output/local.settings.json
        
        # Create deployment package
        echo "üì¶ Creating deployment package..."
        cd ./output
        zip -r ../function-app.zip ./*
        cd ..
        
        echo "üì¶ Deployment package contents:"
        unzip -l function-app.zip
        if [ -f function-app.zip ]; then
          echo "‚úÖ function-app.zip created successfully!"
        else
          echo "‚ùå ZIP creation failed!"
          exit 1
        fi

    - name: 'Pre-deployment Check'
      shell: bash
      run: |
        echo "üìù Checking Function App configuration..."
        az functionapp config show \
          --name ${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }} \
          --resource-group ${{ vars.RESOURCE_GROUP_FUNCTIONS_NAME }} \
          --query "{runtime:linuxFxVersion,platform:use32BitWorkerProcess}"

        echo "üì¶ Verifying package contents..."
        ls -la ./output
        
        echo "üîß Checking host.json..."
        cat ./output/host.json

    - name: 'Configure Function App Settings'
      shell: bash
      run: |
        echo "‚öôÔ∏è Configuring Function App settings..."
        echo "Function App Name: ${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }}"
        echo "Resource Group: ${{ vars.RESOURCE_GROUP_FUNCTIONS_NAME }}"
        echo "Storage Account Name: ${{ vars.STORAGE_ACCOUNT_NAME }}"
        echo "Storage Connection String: ${{ secrets.STORAGE_CONNECTION_STRING }}"
        # Configure function app for Linux and .NET 8.0
        az functionapp config set \
          --name ${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }} \
          --resource-group ${{ vars.RESOURCE_GROUP_FUNCTIONS_NAME }} \
          --linux-fx-version "DOTNET-ISOLATED|8.0" \
          --net-framework-version "v8.0" \
          --use-32bit-worker-process false

        # Set content share name based on function app name
        CONTENT_SHARE="${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }}-content"

        # Configure application settings
        az functionapp config appsettings set \
          --name ${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }} \
          --resource-group ${{ vars.RESOURCE_GROUP_FUNCTIONS_NAME }} \
          --settings \
            AzureWebJobsStorage="${{ secrets.STORAGE_CONNECTION_STRING }}" \
            WEBSITE_CONTENTAZUREFILECONNECTIONSTRING="${{ secrets.STORAGE_CONNECTION_STRING }}" \
            WEBSITE_CONTENTSHARE="$CONTENT_SHARE" \
            FUNCTIONS_EXTENSION_VERSION="~4" \
            FUNCTIONS_WORKER_RUNTIME="dotnet-isolated" \
            WEBSITE_RUN_FROM_PACKAGE="1" \
            SCM_DO_BUILD_DURING_DEPLOYMENT="false" \
            ENABLE_ORYX_BUILD="false" \
            StorageAccountName="${{ vars.STORAGE_ACCOUNT_NAME }}"

    - name: 'Deploy to Azure Function App'
      uses: Azure/functions-action@v1
      id: deploy
      with:
        app-name: ${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }}
        package: ./function-app.zip
        respect-funcignore: true
        scm-do-build-during-deployment: false
        enable-oryx-build: false

    - name: 'Verify Deployment'
      if: always()
      shell: bash
      run: |
        echo "‚è≥ Waiting for deployment to stabilize..."
        sleep 30
        
        echo "üìã Checking deployment status..."
        az functionapp deployment source show \
          --name ${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }} \
          --resource-group ${{ vars.RESOURCE_GROUP_FUNCTIONS_NAME }} \
          --query "{status:status,author:author,message:message,deployer:deployer}"

        echo "üîç Checking Function App status..."
        az functionapp show \
          --name ${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }} \
          --resource-group ${{ vars.RESOURCE_GROUP_FUNCTIONS_NAME }} \
          --query "{State:state,DefaultHostName:defaultHostName,LastModified:lastModifiedTimeUtc,RuntimeVersion:siteConfig.netFrameworkVersion}"

    - name: 'Verify Content Share'
      if: always()
      shell: bash
      run: |
        echo "üîç Verifying content share..."
        CONTENT_SHARE="${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }}-content"
        
        # Check if content share exists
        az storage share exists \
          --name "$CONTENT_SHARE" \
          --account-name "${{ vars.STORAGE_ACCOUNT_NAME }}" \
          --account-key $(az storage account keys list \
            --account-name "${{ vars.STORAGE_ACCOUNT_NAME }}" \
            --resource-group "${{ vars.RESOURCE_GROUP_FUNCTIONS_NAME }}" \
            --query "[0].value" -o tsv) \
          --query "exists" -o tsv

        # Check exit code
        if [ $? -eq 0 ]; then
          echo "‚úÖ Content share '$CONTENT_SHARE' exists and is accessible"
        else
          echo "‚ùå Content share verification failed"
          exit 1
        fi

    - name: 'Sync Function Triggers'
      if: success()
      shell: bash
      run: |
        echo "üîÑ Restarting Function App..."
        az functionapp restart \
          --name ${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }} \
          --resource-group ${{ vars.RESOURCE_GROUP_FUNCTIONS_NAME }}

        echo "‚è≥ Waiting for restart to complete..."
        sleep 30

        echo "üìä Getting Function App status..."
        az functionapp show \
          --name ${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }} \
          --resource-group ${{ vars.RESOURCE_GROUP_FUNCTIONS_NAME }} \
          --query "{State:state,RuntimeVersion:siteConfig.netFrameworkVersion,LinuxFxVersion:siteConfig.linuxFxVersion}" \
          -o json || echo "‚ö†Ô∏è Unable to get Function App status"

        echo "üìÇ Checking deployment files..."
        KUDU_URL="https://${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }}.scm.azurewebsites.net"
        az rest --method get \
          --uri "${KUDU_URL}/api/deployments/latest" \
          --query "{status: status, author: author, message: message}" \
          -o json || echo "‚ö†Ô∏è Unable to verify deployment"

        echo "üîÑ Forcing trigger sync..."
        az rest --method post \
          --uri "https://${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }}.azurewebsites.net/admin/host/synctriggers" \
          --headers "Content-Type=application/json" || echo "‚ö†Ô∏è Function sync command failed"

        echo "‚è≥ Waiting for sync to complete..."
        sleep 45

        echo "üìã Listing functions..."
        az rest --method get \
          --uri "https://${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }}.scm.azurewebsites.net/api/functions" \
          --query "[].{name:name,language:language}" \
          -o json > functions.json

        if [ -s functions.json ] && [ "$(cat functions.json)" != "[]" ]; then
          echo "‚úÖ Functions found:"
          cat functions.json
        else
          echo "‚ùå No functions found. Checking logs..."
          echo "üìú Recent function app logs:"
          az webapp log tail \
            --name ${{ vars.AZURE_FUNCTIONAPP_NAME_DEV }} \
            --resource-group ${{ vars.RESOURCE_GROUP_FUNCTIONS_NAME }} \
            --provider http || echo "‚ö†Ô∏è Unable to retrieve logs"
          
          echo "üìú Kudu logs:"
          az rest --method get \
            --uri "${KUDU_URL}/api/logs/recent" \
            --query "[].{message:message,level:level}" \
            -o json || echo "‚ö†Ô∏è Unable to retrieve Kudu logs"
          exit 1
        fi
    - name: 'Report Deployment Status'
      if: always()
      shell: bash
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Deployment completed successfully"
        else
          echo "‚ùå Deployment failed"
          exit 1
        fi